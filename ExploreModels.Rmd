---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Cmd+Shift+Enter*. 

Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Cmd+Option+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Cmd+Shift+K* to preview the HTML file). 

The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.

```{r}
# Library
library(tidyverse)
library(mgcv)
library(googlesheets4)
library(ggplot2)
library(dlnm)
library(splines)
```

## Data prep

```{r}
# Load data
df_processed <- read.csv("data/output/processed.csv") %>% 
  # only using april to september in this setting
  filter(month >= 4 & month <= 9)

# County name
counties <- df_processed$county %>% 
  unique()
```

```{r}
head(df_processed)
```


## Exploring county level results

```{r}
# Output data
daily_output <- read.csv("data/output/daily_output.csv")
yearly_output <- read.csv("data/output/yearly_output.csv")
output <- read.csv("data/output/output.csv")

# Compare year-by-year
countywise_total <- yearly_output %>% 
  group_by(county) %>% 
  summarize(
    deaths = sum(total_deaths),
    pred = sum(total_pred),
    lo = sum(total_lo),
    up = sum(total_up),
    excess = sum(total_excess),
    excess_lo = sum(total_excess_lo),
    excess_up = sum(total_excess_up)
  )

# Barplot
ggplot(countywise_total, aes(x=county, y=excess)) + 
  geom_bar(stat = "identity") +
  geom_errorbar( aes(x=county, ymin=excess_lo, ymax=excess_up), width=0.4, colour="orange", alpha=0.9, size=1.3) +
  coord_flip()

ggsave("countywise_excess.png", width=4, height=6)
```

```{r}
countywise_heat <- df_processed %>% 
  group_by(county, year) %>% 
  summarize(
    avg_hi = mean(hi),
    count_heat_daily = sum(is_heat_event_daily, na.rm = TRUE),
    count_heat_summer = sum(is_heat_event_summer, na.rm = TRUE)
  )

# Compare year-by-year
countywise_yearly <- yearly_output %>% 
  group_by(county, year) %>% 
  summarize(
    excess = sum(total_excess),
  )

# Merge
county_merged <- full_join(
  countywise_heat, countywise_yearly,
  by = c("county", "year")
)

for(i in 1:length(counties)) {
  c <- counties[i]
  
  print(paste0(i, " ", c, "..."))
  
  df_county_merged <- county_merged %>% 
    filter(county == c)
  
  print(head(df_county_merged))
  
  ggplot(df_county_merged)  +  
  geom_bar(aes(x=year, y=excess),stat="identity", fill="cyan",colour="#006000")+ 
  geom_line(aes(x=year, y=avg_hi - 90),stat="identity",color="red")
  # labs(title= "Courses vs Students Enrolled in GeeksforGeeks", 
   #    x="Year",y="Number of Courses Sold") 
  
  ggsave(paste0("mockups/excessByTemp/", c, ".png"))
}
```

## Correlation testing

```{r}
for(i in 1:length(counties)) {
  c <- counties[i]
  
  print(paste0(i, " ", c, "..."))
  
  df_county <- df_processed %>% 
    filter(county == c)
  
  lm <- ggplot(data = df_county,
       mapping = aes(x = hi, y = deaths, color=is_heat_event)) +
  geom_point() +
  labs(title = "Heat Event associated with increased loss of life",
       subtitle = "Correlation with increased heat and loss of life is stronger for days denoted as a heat event. Definition of heat event varies by county and year.",
       x = "Daily High (F)", # x-axis label
       y = "Deaths",
       color = "Is heat event") +
  stat_smooth(method = "lm",
              formula = y ~ x,
              geom = "smooth")

  ggsave(paste0("mockups/eventByDeath/", c, ".png"))
}
```
```{r}
lm <- ggplot(data = df_county,
       mapping = aes(x = hi, y = deaths, color=ifelse(lag(is_heat_event) | lag(is_heat_event,2) | lag(is_heat_event,3) | lag(is_heat_event,4), T, F))) +
  geom_point() +
  labs(title = "Recent heat event associated with increased loss of life",
       subtitle = "Definition of heat event varies by county and year.",
       x = "Daily High (F)", # x-axis label
       y = "Deaths",
       color = "Recent heat event") +
  stat_smooth(method = "lm",
              formula = y ~ x,
              geom = "smooth")
ggsave("recentHeatEvent.png")
lm
```

## Recency/Variable Testing

```{r}
# the linear model
model <- lm(
  deaths ~ 
    is_heat_event +
    pmax(hi - 90, 0) +
    year + # controlling by year
    ifelse(lag(is_heat_event) | lag(is_heat_event,2) | lag(is_heat_event,3) | lag(is_heat_event,4), T, F) + 
    as.factor(month) +
    as.factor(is_weekend) +
    offset(log(population)),
  data = df_county
)

summary(model)
```


## Lag Modeling
Main resources:
Overview: https://cran.r-project.org/web/packages/dlnm/vignettes/dlnmOverview.pdf
Examples: https://cran.r-project.org/web/packages/dlnm/vignettes/dlnmTS.pdf
Documentation: https://cran.r-project.org/web/packages/dlnm/dlnm.pdf

Additional resources:
Package paper: https://www.ncbi.nlm.nih.gov/pmc/articles/PMC3191524/#:~:text=Distributed%20lag%20non%2Dlinear%20models,effects%20in%20time%20series%20data.
Modeling heat with package: https://journals.lww.com/epidem/fulltext/2006/11000/models_for_the_relationship_between_ambient.6.aspx
Suggested paper: https://academic.oup.com/ije/article/53/3/dyae061/7654027


```{r}
#dlnm examples
summary(chicagoNMMAPS)
### relationship between temperature and mortality: double threshold
b <- onebasis(chicagoNMMAPS$temp, "thr", thr=c(10,25))
summary(b)
model <- glm(death ~ b, family=quasipoisson(), chicagoNMMAPS)
pred <- crosspred(b, model, by=1)
plot(pred, xlab="Temperature (C)", ylab="RR", main="RR for temperature")

summary(df_county$celsius)
# with our data
df_county$celsius <- with(df_county, (hi-32)*5/9)
our_b <- onebasis(df_county$celsius, "thr", thr=25)
summary(our_b)
model <- glm(deaths ~ our_b, family=quasipoisson(), df_county)
pred <- crosspred(our_b, model, by=1)
pred <- crosspred(our_b, model)
plot(pred, xlab="Temperature (C)", ylab="RR", main="RR for temperature")
```

```{r}
df_county$celsius <- with(df_county, (hi-32)*5/9)

# splines visual example adaption
temp_basis <- crossbasis(df_county$celsius, lag=3, argvar=list(df=5),
arglag=list(fun="strata",breaks=1))

model1 <- glm(deaths ~ temp_basis +
                year +
                as.factor(month) +
                as.factor(is_weekend) +
                offset(log(population)),
family=quasipoisson(), df_county)

pred1 <- crosspred(temp_basis, model1, at=0:20, bylag=1, cumul=TRUE)

plot(pred1, "slices", var=10, col=3, ylab="RR", ci.arg=list(density=15,lwd=2),
main="Association with a 10-degree increase in Temp (C)")
plot(pred1, "slices", var=10, col=2, cumul=TRUE, ylab="Cumulative RR",
main="Cumulative association with a 10-degree increase in Temp (C)")
```


```{r}
df_county$recent_hi <- crossbasis(df_county$hi, lag=3, argvar=list(df=3),
arglag=list(fun="strata",breaks=1))

df_county$recent_heat_event <- crossbasis(df_county$is_heat_event, lag=4, argvar=list(df=1),
arglag=list(fun="log"))

summary(df_county$recent_heat_event)

# the generative additive model
model <- gam(
  deaths ~ 
    # is_heat_event +
    # pmax(hi - 90, 0) +
    year + # controlling by year
    recent_heat_event +
    # recent_hi +
    # ifelse(lag(is_heat_event) | lag(is_heat_event,2) | lag(is_heat_event,3) | lag(is_heat_event,4), T, F) + 
    as.factor(month) +
    as.factor(is_weekend) +
    offset(log(population)),
  family = nb(link = "log"),
  data = df_county
)

summary(model)
plot(pred, xlab="recent_heat_event", ylab="RR", main="RR for recent_heat_event")
```
```{r}
# the glm with quasipoisson family (like a tutorial)
model <- glm(
  deaths ~ 
    is_heat_event +
    # pmax(hi - 90, 0) +
    year + # controlling by year
    # recent_heat_event +
    # recent_hi +
    # ifelse(lag(is_heat_event) | lag(is_heat_event,2) | lag(is_heat_event,3) | lag(is_heat_event,4), T, F) + 
    as.factor(month) +
    as.factor(is_weekend) +
    offset(log(population)),
  family = quasipoisson(),
  data = df_county
)

summary(model)
```


## Compare average heat index and the number of heat event days for each county

```{r}
for(i in 0:6) {
  start <- i * 6 + 1
  end <- i * 6 + 6
  
  counties_batch <- counties[start:end]
  
  df_county <- df_processed %>% 
    filter(county %in% larger_counties) %>% 
    filter(county %in% counties_batch)
  
  df_county_summarized <- df_county %>% 
    group_by(year, county) %>% 
    summarize(
      daily = sum(is_heat_event_daily),
      monthly = sum(is_heat_event_monthly),
      summer = sum(is_heat_event_summer),
      avg_heat_index = mean(hi)
    ) %>% 
    ungroup() %>% 
    pivot_longer(
      cols = daily:summer,
      names_to = "heat_event_category",
      values_to = "heat_event_days"
    )
  
  df_county_summarized %>% 
    ggplot() +
    geom_col(aes(x = year, y = heat_event_days, fill = heat_event_category), position = position_dodge(0.7), width = 0.6) +
    geom_line(aes(x = year, y = (avg_heat_index -40))) +
    scale_y_continuous(sec.axis = sec_axis(~(.+40), name = "avg_heat_index")) +
    scale_fill_manual(values = c("#ffcdab", "#ff8432", "#973d00")) +
    facet_wrap(~county, scales = "free_y") +
    theme_minimal() +
    theme(legend.position = "top")
  
  ggsave(paste0("mockups/heatEventDays/", i, ".png"))
}
```

